<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${community.name}">Community</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/css/styles.css}" rel="stylesheet">

    <style>
        /* Helpers */
        .hidden {
            display: none !important
        }

        .muted {
            color: #6b7280
        }

        .btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid #111827;
            background: #111827;
            color: #fff;
            font-weight: 600;
            cursor: pointer
        }

        .btn.ghost {
            background: #fff;
            color: #111827;
            border-color: #d1d5db
        }

        .btn.primary {
            background: #111827;
            color: #fff;
            border-color: #111827
        }

        /* Header */
        .hero {
            display: flex;
            gap: 18px;
            align-items: center;
            margin-bottom: 18px
        }

        .hero-img {
            width: 140px;
            height: 90px;
            object-fit: cover;
            border-radius: 12px;
            border: 1px solid #e5e7eb
        }

        .hero-placeholder {
            width: 140px;
            height: 90px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #94a3b8;
            font-size: 12px
        }

        /* Composer */
        .post-composer {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            box-shadow: 0 12px 36px rgba(0, 0, 0, .07);
            margin-bottom: 16px
        }

        .post-composer .composer-head {
            padding: 14px 16px;
            border-bottom: 1px solid #eef2f7
        }

        .post-composer .composer-title {
            font-weight: 700
        }

        .post-composer .composer-hint {
            color: #6b7280;
            font-size: 12px
        }

        .composer-form {
            padding: 14px 16px;
            display: grid;
            gap: 12px
        }

        .input, .textarea {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 10px 12px;
            outline: none;
            width: 100%
        }

        .textarea {
            resize: vertical;
            min-height: 80px
        }

        .img-row {
            display: grid;
            grid-template-columns:1fr auto;
            gap: 10px
        }

        .actions {
            display: flex;
            justify-content: flex-end
        }

        .img-preview {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden
        }

        .img-preview img {
            width: 100%;
            height: auto;
            display: block;
            max-height: 360px;
            object-fit: cover
        }

        /* Posts */
        .post-card {
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .06);
            padding: 12px 14px;
            margin-bottom: 16px
        }

        /* Comments */
        .comment-thread {
            margin-top: 10px
        }

        .comment-item {
            padding: 10px 0
        }

        .comment-meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px
        }

        .comment-replies {
            margin-top: 6px;
            margin-left: 18px;
            padding-left: 12px;
            border-left: 2px solid #e5e7eb
        }
    </style>
</head>
<body>
<div th:replace="fragments/nav :: navbar"></div>

<main class="container" style="padding:20px 0">

    <!-- Hero header (no broken image when URL missing) -->
    <section class="hero">
        <img class="hero-img"
             th:if="${community.coverImageUrl != null and !#strings.isEmpty(community.coverImageUrl)}"
             th:src="${community.coverImageUrl}" alt="">
        <div class="hero-placeholder"
             th:unless="${community.coverImageUrl != null and !#strings.isEmpty(community.coverImageUrl)}">No cover
        </div>

        <div>
            <h1 style="font-size:22px;font-weight:700;margin:0" th:text="${community.name}">Community</h1>
            <div class="muted" th:text="${community.category} + ' • ' + ${community.location}">Meta</div>
            <div class="muted"><span id="memberCount" th:text="${memberCount}">0</span> members</div>
        </div>
        <div style="margin-left:auto">
            <button id="toggleJoinBtn" class="btn ghost"
                    th:classappend="${isMember}? ' primary' : ''"
                    th:text="${isMember}? 'Joined' : 'Join'"></button>
            <input type="hidden" id="communityId" th:value="${community.id}">
        </div>
    </section>

    <!-- Create post composer (always rendered; toggled via class) -->
    <section id="postComposer" class="post-composer" th:classappend="${isMember} ? '' : ' hidden'">
        <div class="composer-head">
            <div class="composer-title">Create a post</div>
            <div class="composer-hint">Share updates, questions, photos…</div>
        </div>

        <form id="createPostForm" class="composer-form">
            <input type="text" class="input" name="title" placeholder="Title (optional)">
            <textarea class="textarea autosize" name="content" placeholder="What's on your mind?" rows="4"></textarea>

            <div class="img-row">
                <input class="input" name="imageUrl" placeholder="Image URL (optional)">
                <button class="btn ghost" id="previewToggle" type="button">Preview</button>
            </div>

            <div class="img-preview" id="imgPreview" hidden>
                <img id="imgPreviewImg" alt="">
            </div>

            <div class="actions">
                <button class="btn" type="submit">Post</button>
            </div>
        </form>
    </section>

    <!-- Posts list -->
    <section th:each="p: ${posts.content}" class="post-card">
        <div style="display:flex;justify-content:space-between;gap:10px">
            <div>
                <div style="font-weight:600" th:text="${p.title} ?: 'Post'">Post</div>
                <div class="muted" th:text="${#temporals.format(p.createdAt, 'dd MMM yyyy, h:mm a')}">when</div>
            </div>
            <div th:if="${p.imageUrl}">
                <img th:src="${p.imageUrl}" alt=""
                     style="width:140px;height:90px;object-fit:cover;border-radius:10px;border:1px solid #e5e7eb">
            </div>
        </div>
        <div style="margin-top:8px; white-space:pre-wrap" th:text="${p.content}"></div>

        <!-- Comments -->
        <details style="margin-top:8px">
            <summary class="muted">Comments</summary>
            <div class="comment-thread">
                <form class="comment-form" th:attr="data-post-id=${p.id}">
                    <textarea class="input" rows="2" placeholder="Write a comment..."></textarea>
                    <button class="btn" type="submit">Comment</button>
                </form>
                <div class="comments" th:replace="community/fragments :: commentsTree(${p.id})"></div>
            </div>
        </details>
    </section>

    <!-- Pagination -->
    <div class="pagination" style="display:flex;gap:8px;justify-content:center;margin-top:18px">
        <a class="btn ghost" th:if="${posts.hasPrevious()}"
           th:href="@{'/communities/'+${community.id}+'?page='+${posts.number-1}+'&size='+${posts.size}}">Prev</a>
        <span style="padding:8px 12px">Page <span th:text="${posts.number+1}"></span> / <span
                th:text="${posts.totalPages}"></span></span>
        <a class="btn ghost" th:if="${posts.hasNext()}"
           th:href="@{'/communities/'+${community.id}+'?page='+${posts.number+1}+'&size='+${posts.size}}">Next</a>
    </div>
</main>

<script>
    // Join/Leave + toggle composer
    const joinBtn = document.getElementById('toggleJoinBtn');
    const composer = document.getElementById('postComposer');
    if (joinBtn) {
        joinBtn.addEventListener('click', async () => {
            const id = document.getElementById('communityId').value;
            const res = await fetch(`/api/communities/${id}/toggle-join`, {method: 'POST'});
            if (res.ok) {
                const j = await res.json();
                document.getElementById('memberCount').textContent = j.memberCount;
                joinBtn.textContent = j.joined ? 'Joined' : 'Join';
                joinBtn.classList.toggle('primary', j.joined);
                joinBtn.classList.toggle('ghost', !j.joined);
                // show/hide composer immediately
                if (composer) composer.classList.toggle('hidden', !j.joined);
            }
        });
    }

    // Auto-size textarea
    document.querySelectorAll('.autosize').forEach(t => {
        const resize = () => {
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
        };
        t.addEventListener('input', resize);
        resize();
    });

    // Image preview toggle
    const previewToggle = document.getElementById('previewToggle');
    const imgUrlInput = document.querySelector('#createPostForm [name="imageUrl"]');
    const imgPreview = document.getElementById('imgPreview');
    const imgPreviewImg = document.getElementById('imgPreviewImg');
    if (previewToggle && imgUrlInput) {
        previewToggle.addEventListener('click', () => {
            const url = (imgUrlInput.value || '').trim();
            if (!url) {
                imgPreview.hidden = true;
                return;
            }
            imgPreviewImg.src = url;
            imgPreview.hidden = false;
        });
    }

    // Create post
    const postForm = document.getElementById('createPostForm');
    if (postForm) {
        postForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('communityId').value;
            const dto = {
                title: postForm.title.value || null,
                content: postForm.content.value,
                imageUrl: postForm.imageUrl.value || null
            };
            const res = await fetch(`/api/communities/${id}/posts`, {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dto)
            });
            if (res.ok) location.reload();
        });
    }

    // Comments (top-level + replies)
    document.querySelectorAll('.comment-form').forEach(form => {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const postId = form.getAttribute('data-post-id');
            const content = form.querySelector('textarea').value.trim();
            const parentId = form.querySelector('[name="parentId"]')?.value;
            if (!content) return;
            const res = await fetch(`/api/communities/posts/${postId}/comments`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({content, parentId})
            });
            if (res.ok) location.reload();
        });
    });
</script>
</body>
</html>
